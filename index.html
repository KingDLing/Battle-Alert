<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Alert - Universal Notification System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All existing CSS remains the same, adding new styles at the end */
        
        /* Profile dropdown */
        .profile-dropdown {
            position: relative;
        }
        
        .profile-btn {
            background: transparent;
            border: 1px solid var(--white);
            color: var(--white);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .profile-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--dark-gray);
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            min-width: 200px;
            display: none;
            z-index: 1000;
            margin-top: 5px;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 12px 15px;
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .dropdown-item.danger {
            color: var(--alert-red);
        }
        
        .dropdown-item.danger:hover {
            background-color: rgba(255, 61, 0, 0.1);
        }
        
        /* Admin controls */
        .admin-controls {
            background-color: rgba(255, 152, 0, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid var(--warning-orange);
        }
        
        .admin-controls h4 {
            color: var(--warning-orange);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Alert clearing */
        .clear-alerts-btn {
            background-color: var(--medium-gray);
            color: white;
            margin-top: 10px;
        }
        
        .clear-alerts-btn:hover {
            background-color: #5d5d5d;
        }
    </style>
</head>
<body>
    <!-- All existing modals remain the same -->
    <!-- Adding a new modal for clearing alerts -->
    <div id="clear-alerts-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-trash-alt"></i> Clear All Alerts</h2>
            <div id="clear-alerts-content">
                <p>Are you sure you want to clear all alert logs?</p>
                <p style="color: var(--medium-gray); font-size: 0.9rem; margin-top: 10px;">
                    This will remove all alert history but will NOT affect gamer statistics.
                </p>
                <div class="form-group" style="margin-top: 20px;">
                    <label>
                        <input type="checkbox" id="confirm-clear">
                        I understand this action cannot be undone
                    </label>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="form-btn form-btn-secondary" id="cancel-clear-alerts">Cancel</button>
                <button type="button" class="form-btn form-btn-danger" id="confirm-clear-alerts" disabled>Clear All Alerts</button>
            </div>
        </div>
    </div>

    <!-- New modal for resetting stats -->
    <div id="reset-stats-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-chart-line"></i> Reset Statistics</h2>
            <div id="reset-stats-content">
                <p>Are you sure you want to reset all statistics?</p>
                <p style="color: var(--medium-gray); font-size: 0.9rem; margin-top: 10px;">
                    This will reset today's alerts, total alerts, and response times to zero.
                </p>
                <div class="form-group" style="margin-top: 20px;">
                    <label>
                        <input type="checkbox" id="confirm-reset">
                        I understand this action cannot be undone
                    </label>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="form-btn form-btn-secondary" id="cancel-reset-stats">Cancel</button>
                <button type="button" class="form-btn form-btn-danger" id="confirm-reset-stats" disabled>Reset Statistics</button>
            </div>
        </div>
    </div>

    <!-- All existing HTML structure remains the same -->
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="logo-text">
                    <h1>Battle Alert</h1>
                    <p>Universal Game Notification System</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="current-user" id="current-user-display" style="display: none;">
                    <div class="profile-dropdown">
                        <button class="profile-btn" id="profile-btn">
                            <i class="fas fa-user"></i>
                            <span id="current-username">Guest</span>
                            <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                        </button>
                        <div class="dropdown-menu" id="profile-dropdown-menu">
                            <div class="dropdown-item" id="view-profile-btn">
                                <i class="fas fa-id-card"></i> View My Profile
                            </div>
                            <div class="dropdown-item" id="edit-profile-header-btn">
                                <i class="fas fa-edit"></i> Edit Profile
                            </div>
                            <div class="dropdown-item" id="clear-my-alerts-btn">
                                <i class="fas fa-bell-slash"></i> Clear My Alerts
                            </div>
                            <div class="dropdown-item danger" id="logout-header-btn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </div>
                        </div>
                    </div>
                </div>
                <button class="send-alert-btn" id="open-send-alert">
                    <i class="fas fa-bullhorn"></i> Send Alert
                </button>
                <button class="register-btn" id="open-registration">
                    <i class="fas fa-user-plus"></i> Register
                </button>
            </div>
        </header>

        <div class="stats-container">
            <!-- Existing stats cards remain the same -->
            <div class="stat-card">
                <div class="stat-title">TODAY'S ALERTS</div>
                <div class="stat-value" id="today-alerts">0</div>
                <div class="stat-subtext" id="today-response-time">Avg Response: N/A</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">TOTAL ALERTS</div>
                <div class="stat-value" id="total-alerts">0</div>
                <div class="stat-subtext" id="total-response-time">Avg Response: N/A</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ACTIVE GAMERS</div>
                <div class="stat-value" id="active-gamers">0</div>
                <div class="stat-subtext">Registered in system</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">RESPONSE RATE</div>
                <div class="stat-value" id="response-rate">0%</div>
                <div class="stat-subtext">Alerts responded to</div>
            </div>
        </div>

        <!-- Adding admin controls section -->
        <div class="card" id="admin-controls-card" style="display: none;">
            <h2 class="card-title"><i class="fas fa-user-shield"></i> Admin Controls</h2>
            <div class="admin-controls">
                <h4><i class="fas fa-cogs"></i> System Management</h4>
                <div class="action-buttons">
                    <button class="action-btn clear-alerts-btn" id="clear-all-alerts-btn">
                        <i class="fas fa-trash-alt"></i> Clear All Alert Logs
                    </button>
                    <button class="action-btn vote-btn" id="reset-stats-btn">
                        <i class="fas fa-chart-line"></i> Reset Statistics
                    </button>
                </div>
            </div>
        </div>

        <!-- Rest of the existing HTML remains exactly the same -->
        <div class="card">
            <h2 class="card-title"><i class="fas fa-history"></i> Recent Alert Log</h2>
            <div class="alert-log-container" id="alert-log-container">
                <div style="text-align: center; padding: 20px; color: var(--medium-gray);">
                    No alerts sent yet
                </div>
            </div>
        </div>

        <!-- ... rest of the HTML remains exactly as before ... -->

    </div>

    <script type="module">
        // All existing imports and Firebase config remain the same
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            serverTimestamp,
            query,
            where,
            orderBy,
            getDocs,
            onSnapshot,
            limit,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqqujNlqmiqlVKXz6WBxfgSXnHP8gIqIk",
            authDomain: "battle-alert.firebaseapp.com",
            projectId: "battle-alert",
            storageBucket: "battle-alert.firebasestorage.app",
            messagingSenderId: "724267211096",
            appId: "1:724267211096:web:8af6a8a63cf0eabb6bed2d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let messagingInstance = null;
        let currentUser = null;
        let allGamers = [];
        let currentAlert = null;
        let currentVoteGamer = null;
        let quickAlertGamer = null;

        // Get all existing modal elements
        const registrationModal = document.getElementById('registration-modal');
        const openRegistrationBtn = document.getElementById('open-registration');
        const cancelRegistrationBtn = document.getElementById('cancel-registration');
        const registrationForm = document.getElementById('registration-form');
        const allianceSelect = document.getElementById('alliance-name');
        const customAllianceGroup = document.getElementById('custom-alliance-group');
        
        const editProfileModal = document.getElementById('edit-profile-modal');
        const editProfileForm = document.getElementById('edit-profile-form');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const editAllianceSelect = document.getElementById('edit-alliance-name');
        const editCustomAllianceGroup = document.getElementById('edit-custom-alliance-group');
        
        // NEW: Profile dropdown elements
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdownMenu = document.getElementById('profile-dropdown-menu');
        const viewProfileBtn = document.getElementById('view-profile-btn');
        const editProfileHeaderBtn = document.getElementById('edit-profile-header-btn');
        const clearMyAlertsBtn = document.getElementById('clear-my-alerts-btn');
        const logoutHeaderBtn = document.getElementById('logout-header-btn');
        
        // NEW: Admin controls elements
        const adminControlsCard = document.getElementById('admin-controls-card');
        const clearAllAlertsBtn = document.getElementById('clear-all-alerts-btn');
        const resetStatsBtn = document.getElementById('reset-stats-btn');
        
        // NEW: Clear alerts modal elements
        const clearAlertsModal = document.getElementById('clear-alerts-modal');
        const cancelClearAlertsBtn = document.getElementById('cancel-clear-alerts');
        const confirmClearAlertsBtn = document.getElementById('confirm-clear-alerts');
        const confirmClearCheckbox = document.getElementById('confirm-clear');
        
        // NEW: Reset stats modal elements
        const resetStatsModal = document.getElementById('reset-stats-modal');
        const cancelResetStatsBtn = document.getElementById('cancel-reset-stats');
        const confirmResetStatsBtn = document.getElementById('confirm-reset-stats');
        const confirmResetCheckbox = document.getElementById('confirm-reset');
        
        // All other existing variable declarations remain the same...

        document.addEventListener('DOMContentLoaded', async function() {
            const savedUserId = localStorage.getItem('battleAlertUserId');
            if (savedUserId) {
                await loadCurrentUser(savedUserId);
            }
            
            await initializePushNotifications();
            setupEventListeners();
            loadGamers();
            updateStats();
            loadAlertLog();
            
            checkForActiveAlerts();
            setupRealtimeUpdates();
            
            // Show/hide admin controls based on current user
            updateAdminControls();
        });

        function updateAdminControls() {
            // Show admin controls for all logged in users (or customize as needed)
            if (currentUser) {
                adminControlsCard.style.display = 'block';
            } else {
                adminControlsCard.style.display = 'none';
            }
        }

        async function loadCurrentUser(userId) {
            try {
                const userDoc = await getDocs(query(collection(db, 'members'), where('__name__', '==', userId)));
                if (!userDoc.empty) {
                    const docSnapshot = userDoc.docs[0];
                    currentUser = {
                        id: docSnapshot.id,
                        ...docSnapshot.data()
                    };
                    updateCurrentUserDisplay();
                    updateAdminControls();
                } else {
                    // User not found, clear invalid ID
                    localStorage.removeItem('battleAlertUserId');
                }
            } catch (error) {
                console.error('Error loading current user:', error);
                localStorage.removeItem('battleAlertUserId');
            }
        }

        function updateCurrentUserDisplay() {
            if (currentUser) {
                currentUsername.textContent = currentUser.gamerName;
                currentUserDisplay.style.display = 'flex';
                openRegistrationBtn.style.display = 'none';
            } else {
                currentUserDisplay.style.display = 'none';
                openRegistrationBtn.style.display = 'flex';
            }
        }

        async function loadGamers() {
            try {
                const querySnapshot = await getDocs(collection(db, 'members'));
                allGamers = [];
                
                querySnapshot.forEach((docSnapshot) => {
                    const gamer = {
                        id: docSnapshot.id,
                        ...docSnapshot.data()
                    };
                    
                    if (gamer.totalAlerts && gamer.totalAlerts > 0) {
                        gamer.avgResponseTime = gamer.totalResponseTime / gamer.totalAlerts;
                    } else {
                        gamer.avgResponseTime = null;
                    }
                    
                    allGamers.push(gamer);
                });
                
                renderGamersTable(allGamers);
                populateSpecificGamerSelect(allGamers);
            } catch (error) {
                console.error('Error loading gamers:', error);
                showNotification('Error', 'Failed to load gamers');
            }
        }

        // NEW FUNCTION: Check if gamer name already exists
        async function checkGamerNameExists(gamerName) {
            try {
                const q = query(
                    collection(db, 'members'),
                    where('gamerName', '==', gamerName)
                );
                const querySnapshot = await getDocs(q);
                return !querySnapshot.empty;
            } catch (error) {
                console.error('Error checking gamer name:', error);
                return false;
            }
        }

        // NEW FUNCTION: Show user profile
        function showUserProfile() {
            if (!currentUser) return;
            
            const modalContent = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 3rem; color: var(--primary-red); margin-bottom: 20px;">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h3 style="color: var(--white); margin-bottom: 10px;">${currentUser.gamerName}</h3>
                    <div style="background-color: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 5px; margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--medium-gray);">Alliance:</span>
                            <span style="color: var(--white); font-weight: bold;">${currentUser.alliance}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--medium-gray);">Alerts Received:</span>
                            <span style="color: var(--white); font-weight: bold;">${currentUser.totalAlerts || 0}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--medium-gray);">Avg Response Time:</span>
                            <span style="color: var(--white); font-weight: bold;">
                                ${currentUser.avgResponseTime ? Math.round(currentUser.avgResponseTime) + 's' : 'N/A'}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--medium-gray);">Status:</span>
                            <span style="color: ${currentUser.status === 'safe' ? 'var(--success-green)' : 'var(--alert-red)'}; font-weight: bold;">
                                ${currentUser.status || 'safe'}
                            </span>
                        </div>
                    </div>
                    <p style="color: var(--medium-gray); font-size: 0.9rem;">
                        Member since: ${currentUser.joinDate ? currentUser.joinDate.toDate().toLocaleDateString() : 'Recently'}
                    </p>
                </div>
            `;
            
            // Create a temporary modal to show profile
            const tempModal = document.createElement('div');
            tempModal.className = 'modal';
            tempModal.style.display = 'flex';
            tempModal.innerHTML = `
                <div class="modal-content">
                    <h2 class="modal-title"><i class="fas fa-user"></i> My Profile</h2>
                    ${modalContent}
                    <div class="form-actions">
                        <button type="button" class="form-btn form-btn-primary" id="close-profile-modal">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tempModal);
            
            tempModal.addEventListener('click', (e) => {
                if (e.target === tempModal || e.target.id === 'close-profile-modal') {
                    document.body.removeChild(tempModal);
                }
            });
        }

        // NEW FUNCTION: Clear user's own alerts
        async function clearMyAlerts() {
            if (!currentUser) return;
            
            try {
                // Query all alerts sent to current user
                const q = query(
                    collection(db, 'alerts'),
                    where('recipientId', '==', currentUser.id)
                );
                
                const querySnapshot = await getDocs(q);
                const batch = writeBatch(db);
                
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Reset user's alert counts
                const userRef = doc(db, 'members', currentUser.id);
                await updateDoc(userRef, {
                    totalAlerts: 0,
                    totalResponseTime: 0,
                    status: 'safe'
                });
                
                showNotification('Success', 'Your alerts have been cleared!');
            } catch (error) {
                console.error('Error clearing alerts:', error);
                showNotification('Error', 'Failed to clear alerts');
            }
        }

        // NEW FUNCTION: Clear ALL alert logs
        async function clearAllAlertLogs() {
            try {
                const querySnapshot = await getDocs(collection(db, 'alerts'));
                const batch = writeBatch(db);
                
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Also reset all users' alert counts
                const gamersSnapshot = await getDocs(collection(db, 'members'));
                const updateBatch = writeBatch(db);
                
                gamersSnapshot.forEach((doc) => {
                    const gamerRef = doc.ref;
                    updateBatch.update(gamerRef, {
                        totalAlerts: 0,
                        totalResponseTime: 0,
                        status: 'safe'
                    });
                });
                
                await updateBatch.commit();
                
                showNotification('Success', 'All alert logs have been cleared!');
            } catch (error) {
                console.error('Error clearing all alerts:', error);
                showNotification('Error', 'Failed to clear alert logs');
            }
        }

        // NEW FUNCTION: Reset all statistics
        async function resetStatistics() {
            try {
                // Clear all alerts
                const alertsSnapshot = await getDocs(collection(db, 'alerts'));
                const batch = writeBatch(db);
                
                alertsSnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Reset all users' statistics
                const gamersSnapshot = await getDocs(collection(db, 'members'));
                const updateBatch = writeBatch(db);
                
                gamersSnapshot.forEach((doc) => {
                    const gamerRef = doc.ref;
                    updateBatch.update(gamerRef, {
                        totalAlerts: 0,
                        totalResponseTime: 0,
                        status: 'safe',
                        lastAlert: null
                    });
                });
                
                await updateBatch.commit();
                
                showNotification('Success', 'All statistics have been reset!');
            } catch (error) {
                console.error('Error resetting statistics:', error);
                showNotification('Error', 'Failed to reset statistics');
            }
        }

        // Update the registration form submit to check for duplicates
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const gamerName = document.getElementById('gamer-name').value.trim();
            const alliance = document.getElementById('alliance-name').value;
            const customAlliance = document.getElementById('custom-alliance').value.trim();

            if (!gamerName) {
                showNotification('Error', 'Please enter a gamer name');
                return;
            }

            // NEW: Check if gamer name already exists
            const nameExists = await checkGamerNameExists(gamerName);
            if (nameExists) {
                showNotification('Error', `Gamer name "${gamerName}" is already taken. Please choose another.`);
                return;
            }

            let finalAlliance = alliance;
            if (alliance === 'custom') {
                if (!customAlliance) {
                    showNotification('Error', 'Please enter a custom alliance name');
                    return;
                }
                finalAlliance = customAlliance;
            }

            try {
                const docRef = await addDoc(collection(db, 'members'), {
                    gamerName: gamerName,
                    alliance: finalAlliance,
                    joinDate: serverTimestamp(),
                    status: 'safe',
                    lastAlert: null,
                    totalAlerts: 0,
                    totalResponseTime: 0,
                    fcmToken: localStorage.getItem('battleAlertFCMToken')
                });

                currentUser = {
                    id: docRef.id,
                    gamerName: gamerName,
                    alliance: finalAlliance
                };

                localStorage.setItem('battleAlertUserId', docRef.id);

                showNotification('Success', `${gamerName} has been successfully registered!`);
                updateCurrentUserDisplay();
                updateAdminControls();
                registrationForm.reset();
                customAllianceGroup.style.display = 'none';
                
                setTimeout(() => {
                    registrationModal.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Error registering gamer:', error);
                showNotification('Error', 'Failed to register gamer');
            }
        });

        // Update the edit profile form to check for duplicates
        editProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const gamerName = document.getElementById('edit-gamer-name').value.trim();
            const alliance = document.getElementById('edit-alliance-name').value;
            const customAlliance = document.getElementById('edit-custom-alliance').value.trim();

            if (!gamerName) {
                showNotification('Error', 'Please enter a gamer name');
                return;
            }

            // NEW: Check if new gamer name already exists (and it's not the current user)
            if (gamerName !== currentUser.gamerName) {
                const nameExists = await checkGamerNameExists(gamerName);
                if (nameExists) {
                    showNotification('Error', `Gamer name "${gamerName}" is already taken. Please choose another.`);
                    return;
                }
            }

            let finalAlliance = alliance;
            if (alliance === 'custom') {
                if (!customAlliance) {
                    showNotification('Error', 'Please enter a custom alliance name');
                    return;
                }
                finalAlliance = customAlliance;
            }

            try {
                const userRef = doc(db, 'members', currentUser.id);
                await updateDoc(userRef, {
                    gamerName: gamerName,
                    alliance: finalAlliance
                });

                currentUser.gamerName = gamerName;
                currentUser.alliance = finalAlliance;
                updateCurrentUserDisplay();

                showNotification('Success', 'Profile updated successfully!');
                editProfileModal.style.display = 'none';
                editProfileForm.reset();
                editCustomAllianceGroup.style.display = 'none';
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error', 'Failed to update profile');
            }
        });

        function setupEventListeners() {
            // All existing event listeners remain...
            
            // NEW: Profile dropdown toggle
            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdownMenu.classList.toggle('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                profileDropdownMenu.classList.remove('show');
            });

            // NEW: View profile button
            viewProfileBtn.addEventListener('click', () => {
                profileDropdownMenu.classList.remove('show');
                showUserProfile();
            });

            // NEW: Edit profile from header
            editProfileHeaderBtn.addEventListener('click', () => {
                profileDropdownMenu.classList.remove('show');
                openEditProfileModal(currentUser.id);
            });

            // NEW: Clear my alerts
            clearMyAlertsBtn.addEventListener('click', async () => {
                profileDropdownMenu.classList.remove('show');
                if (confirm('Are you sure you want to clear all your alerts? This cannot be undone.')) {
                    await clearMyAlerts();
                }
            });

            // NEW: Logout from header
            logoutHeaderBtn.addEventListener('click', () => {
                profileDropdownMenu.classList.remove('show');
                logout();
            });

            // NEW: Clear all alerts button
            clearAllAlertsBtn.addEventListener('click', () => {
                clearAlertsModal.style.display = 'flex';
            });

            // NEW: Reset stats button
            resetStatsBtn.addEventListener('click', () => {
                resetStatsModal.style.display = 'flex';
            });

            // NEW: Clear alerts modal
            cancelClearAlertsBtn.addEventListener('click', () => {
                clearAlertsModal.style.display = 'none';
                confirmClearCheckbox.checked = false;
                confirmClearAlertsBtn.disabled = true;
            });

            clearAlertsModal.addEventListener('click', (e) => {
                if (e.target === clearAlertsModal) {
                    clearAlertsModal.style.display = 'none';
                    confirmClearCheckbox.checked = false;
                    confirmClearAlertsBtn.disabled = true;
                }
            });

            confirmClearCheckbox.addEventListener('change', () => {
                confirmClearAlertsBtn.disabled = !confirmClearCheckbox.checked;
            });

            confirmClearAlertsBtn.addEventListener('click', async () => {
                await clearAllAlertLogs();
                clearAlertsModal.style.display = 'none';
                confirmClearCheckbox.checked = false;
                confirmClearAlertsBtn.disabled = true;
            });

            // NEW: Reset stats modal
            cancelResetStatsBtn.addEventListener('click', () => {
                resetStatsModal.style.display = 'none';
                confirmResetCheckbox.checked = false;
                confirmResetStatsBtn.disabled = true;
            });

            resetStatsModal.addEventListener('click', (e) => {
                if (e.target === resetStatsModal) {
                    resetStatsModal.style.display = 'none';
                    confirmResetCheckbox.checked = false;
                    confirmResetStatsBtn.disabled = true;
                }
            });

            confirmResetCheckbox.addEventListener('change', () => {
                confirmResetStatsBtn.disabled = !confirmResetCheckbox.checked;
            });

            confirmResetStatsBtn.addEventListener('click', async () => {
                await resetStatistics();
                resetStatsModal.style.display = 'none';
                confirmResetCheckbox.checked = false;
                confirmResetStatsBtn.disabled = true;
            });

            // All other existing event listeners remain exactly the same...
            // ... [rest of your existing event listener code] ...
        }

        // All other existing functions remain exactly the same...
    </script>
</body>
</html>
